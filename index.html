<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å››åœ‹å†’éšª v11.0 (é›²ç«¯åŠ å¯†ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        .draggable-item { user-select: none; transition: all 0.2s; cursor: grab; }
        .draggable-item:active { cursor: grabbing; transform: scale(1.01); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .dragging { opacity: 0.5; border: 2px dashed #4f46e5; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .editable:hover { background-color: #f0f9ff; color: #0284c7; cursor: pointer; border-radius: 4px; padding: 0 4px;}
        
        /* è®€å–é®ç½© */
        #loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 pb-32 overflow-y-scroll">

    <div id="loading-overlay">
        <div id="login-box" class="bg-white text-slate-900 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">
            <h2 class="text-2xl font-black mb-4 text-indigo-900">ğŸ”’ è¡Œç¨‹åŠ å¯†ç³»çµ±</h2>
            <p class="text-sm text-slate-500 mb-4">è«‹è¼¸å…¥åœ˜éšŠå…±ç”¨å¯†ç¢¼ä»¥è§£å¯†é›²ç«¯è³‡æ–™</p>
            <input type="password" id="secret-password" placeholder="è¼¸å…¥å¯†ç¢¼..." class="w-full border-2 border-slate-200 rounded-xl p-3 text-lg font-bold mb-4 focus:border-indigo-500 outline-none text-center">
            <button onclick="initCloudSync()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition-all shadow-lg">
                <i class="fas fa-unlock-alt mr-2"></i>è§£é–ä¸¦åŒæ­¥
            </button>
            <div id="login-msg" class="mt-4 text-red-500 text-xs font-bold h-4"></div>
        </div>
        <div id="loading-spinner" class="hidden text-center">
            <i class="fas fa-circle-notch fa-spin text-5xl text-indigo-400 mb-4"></i>
            <p class="font-bold tracking-widest animate-pulse">æ­£åœ¨å¾é›²ç«¯ä¸‹è¼‰ä¸¦è§£å¯†...</p>
        </div>
    </div>

    <header class="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-md">
        <div class="flex justify-between items-center mb-2">
            <div>
                <h1 class="text-lg font-black italic tracking-wider">SHIKOKU 2026</h1>
                <p id="cloud-status" class="text-slate-400 text-[10px] mt-1 flex items-center gap-1">
                    <i class="fas fa-wifi"></i> ç­‰å¾…é€£ç·š...
                </p>
            </div>
            <div class="text-[10px] font-bold border border-slate-600 px-2 py-1 rounded bg-slate-800">V11.0 Cloud</div>
        </div>
        <div class="flex space-x-1 bg-slate-800 p-1 rounded-lg">
            <button onclick="switchTab('itinerary')" id="tab-itinerary" class="flex-1 py-2 text-sm font-bold rounded bg-white text-slate-900 shadow-sm transition-all">è¡Œç¨‹</button>
            <button onclick="switchTab('finance')" id="tab-finance" class="flex-1 py-2 text-sm font-bold rounded text-slate-400 hover:bg-slate-700 hover:text-white transition-all">é ç®—</button>
            <button onclick="switchTab('ledger')" id="tab-ledger" class="flex-1 py-2 text-sm font-bold rounded text-slate-400 hover:bg-slate-700 hover:text-white transition-all">è¨˜å¸³</button>
        </div>
    </header>

    <main id="itinerary-page" class="tab-content active px-4 py-6">
        <div class="text-xs text-slate-400 mb-4 text-center bg-white py-2 rounded-lg shadow-sm">
            <i class="fas fa-cloud-upload-alt mr-1 text-indigo-500"></i>ä»»ä½•ä¿®æ”¹éƒ½æœƒè‡ªå‹•åŠ å¯†ä¸Šå‚³ï¼Œå¤¥ä¼´é‡æ•´å³å¯çœ‹åˆ°ã€‚
        </div>
        <div id="itinerary-list" class="space-y-8"></div>
        <div class="fixed bottom-6 right-6 z-40">
             <button onclick="addNodePrompt()" class="bg-indigo-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center border-2 border-white text-xl hover:scale-105 transition-transform">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </main>

    <main id="finance-page" class="tab-content px-4 py-6 space-y-6">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-slate-50 p-4 border-b flex justify-between items-center cursor-pointer" onclick="document.getElementById('car-details').classList.toggle('hidden')">
                <div class="flex items-center"><i class="fas fa-car-side text-indigo-600 mr-2"></i><span class="font-bold text-sm">Toyota Rent-A-Car</span></div>
                <span class="font-black text-indigo-600 text-sm">Â¥137,679</span>
            </div>
            <div id="car-details" class="p-4 text-xs space-y-2 hidden">
                <p><b>é ç´„è™Ÿç¢¼:</b> 99991680900 (W1 Class)</p>
                <p><b>å–è»Š:</b> 04/29 14:30 æ–°å¤§é˜ªé§…å‰åº—</p>
                <p><b>é‚„è»Š:</b> 05/10 20:00 æ–°å¤§é˜ªé§…å‰åº—</p>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-orange-100 overflow-hidden">
            <div class="p-3 bg-orange-50 border-b border-orange-100 flex justify-between">
                <span class="font-bold text-orange-800 text-sm"><i class="fas fa-hotel mr-2"></i>ä½å®¿æ˜ç´°</span>
                <span class="text-xs bg-white text-orange-600 px-2 py-1 rounded">Â¥431,132</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-xs">
                    <thead class="bg-orange-100 text-orange-800">
                        <tr><th class="p-2">æ—¥æœŸ/é£¯åº—</th><th class="p-2 text-right">ç¸½åƒ¹</th></tr>
                    </thead>
                    <tbody id="hotel-list-body"></tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-4 space-y-3">
            <div class="flex justify-between items-center border-l-4 border-indigo-500 pl-3">
                <h2 class="font-bold text-sm text-slate-700">å€‹äººé ä¼°è² æ“”</h2>
                <button onclick="addFixedExpense()" class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded"><i class="fas fa-plus"></i></button>
            </div>
            <div id="fixed-expense-list" class="space-y-2"></div>
        </div>
    </main>

    <main id="ledger-page" class="tab-content px-4 py-6 space-y-6">
        <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
            <h3 class="font-bold text-xs text-slate-400 mb-2 uppercase">æˆå“¡ (åŒæ­¥å„²å­˜)</h3>
            <div class="flex gap-2 mb-2">
                <input id="new-member-name" type="text" placeholder="è¼¸å…¥å§“å" class="bg-slate-50 border border-slate-200 rounded px-2 py-1 text-xs flex-grow">
                <button onclick="addMember()" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs">æ–°å¢</button>
            </div>
            <div id="member-tags" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="bg-indigo-50 rounded-xl p-4 border border-indigo-100">
            <h3 class="font-bold text-xs text-indigo-500 mb-2">çµç®—å»ºè­°</h3>
            <div id="settlement-result" class="text-xs font-medium text-slate-700 space-y-1"></div>
        </div>

        <div id="expense-container" class="pb-20"></div>

        <div class="fixed bottom-6 left-1/2 -translate-x-1/2 z-40 w-full flex justify-center pointer-events-none">
            <button onclick="openExpenseModal()" class="pointer-events-auto bg-slate-900 text-white px-8 py-3 rounded-full font-bold shadow-2xl flex items-center border-4 border-slate-100 active:scale-95 transition-transform">
                <i class="fas fa-receipt mr-2"></i>è¨˜ä¸€ç­†
            </button>
        </div>
    </main>

    <div id="expense-modal" class="fixed inset-0 bg-slate-900/80 z-[60] hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md sm:rounded-2xl rounded-t-2xl overflow-hidden shadow-2xl animate-[slideUp_0.2s_ease-out]">
            <div class="bg-slate-50 border-b p-3 flex justify-between items-center">
                <h3 class="font-bold text-slate-700">è¨˜å¸³</h3>
                <button onclick="document.getElementById('expense-modal').classList.add('hidden')"><i class="fas fa-times text-slate-400"></i></button>
            </div>
            <div class="p-5 space-y-3">
                <div class="grid grid-cols-3 gap-2">
                    <input type="date" id="input-date" class="col-span-1 bg-slate-50 border rounded p-2 text-sm">
                    <input type="text" id="input-desc" placeholder="é …ç›®" class="col-span-2 bg-slate-50 border rounded p-2 text-sm font-bold">
                </div>
                <div class="relative">
                    <span class="absolute left-3 top-2 text-slate-400">Â¥</span>
                    <input type="number" id="input-amount" placeholder="é‡‘é¡" class="w-full bg-slate-50 border rounded p-2 pl-6 text-lg font-black text-indigo-600">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="text-[10px] text-slate-400">ä»˜æ¬¾äºº</label><select id="input-payer" class="w-full bg-slate-50 border rounded p-2 text-xs font-bold"></select></div>
                    <div><label class="text-[10px] text-slate-400">åˆ†æ”¤</label><button onclick="toggleAllSplit()" class="w-full bg-slate-100 border rounded p-2 text-xs text-indigo-600">å…¨é¸/å–æ¶ˆ</button></div>
                </div>
                <div id="input-split-container" class="grid grid-cols-3 gap-2 max-h-24 overflow-y-auto"></div>
                <button onclick="saveExpense()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow mt-2">å„²å­˜ä¸¦ä¸Šå‚³</button>
            </div>
        </div>
    </div>

<script>
    // ==========================================
    // âš™ï¸ è¨­å®šå€åŸŸ (è«‹æ›¿æ›æˆä½ çš„ JSONBin è³‡æ–™)
    // ==========================================
    const BIN_ID = '6979a2a5ae596e708ffcaa08'; // ä¾‹å¦‚: 65b3f123...
    const API_KEY = '$2a$10$riptLWHFddiwJudT1.BkMuiFmirkcbziLr7ytSl6DrydUhB/XPsvG'; // ä¾‹å¦‚: $2a$10$AbCd...
    // ==========================================

    let PASSWORD = ''; // ç”¨æˆ¶è¼¸å…¥çš„å¯†ç¢¼ï¼Œç”¨æ–¼ AES åŠ å¯†/è§£å¯†
    
    // é è¨­è³‡æ–™ (åˆå§‹åŒ–ç”¨)
    const defaultData = {
        tripData: [
            { date: "04/29", title: "é›†åˆèˆ‡æ‘©è€¶å±±å¤œæ™¯", items: ["æ–°å¤§é˜ª 14:00 é›†åˆ", "æ‘©è€¶å±±å¤œæ™¯", "å±…é…’å±‹æ™šé¤"], hotelIdx: 0 },
            { date: "04/30", title: "ç¥æˆ¶ â” å¾·å³¶", items: ["æ˜çŸ³å¤§æ©‹è¦‹å­¸", "åŒ—é‡ç•°äººé¤¨", "æ·¡è·¯æœå‹™å€", "å¾·å³¶çœ‰å±±"], hotelIdx: 1 },
            { date: "05/01", title: "é³´é–€èˆ‡ç¥–è°·æº«æ³‰", items: ["å¤§é³´é–€æ©‹ æ¸¦ä¹‹é“", "é³´é–€å±•æœ›å°", "ç¥–è°·æº«æ³‰æ—…é¤¨"], hotelIdx: 2 },
            { date: "05/02", title: "å¤§æ­¥å±èˆ‡å¥§ç¥–è°·", items: ["å¤§æ­¥å±å°æ­¥å±", "å¥§ç¥–è°·äºŒé‡è—¤è”“æ©‹", "å››è¬åå¤©æ–‡é¤¨"], hotelIdx: 3 },
            { date: "05/03", title: "å››è¬å â” æ¾å±±", items: ["å››è¬åå·éŠè¦½", "é¾æ²³æ´", "æ¾å±±åŸ"], hotelIdx: 4 },
            { date: "05/04", title: "å³¶æ³¢æµ·é“ â” å°¾é“", items: ["è¡ä»Šæ²»", "å³¶æ³¢æµ·é“è·¨æµ·", "å°¾é“æ•£ç­–"], hotelIdx: 5 },
            { date: "05/05", title: "å°¾é“ â” å²¡å±±", items: ["å°¾é“å•†åº—è¡—", "å€‰æ•·ç¾è§€åœ°å€", "å²¡å±±åŸ"], hotelIdx: 6 },
            { date: "05/06", title: "å²¡å±± â” å°è±†å³¶", items: ["å²¡å±±å¤©ä½¿ä¹‹è·¯", "æ­èˆ¹ç›´å¥”å°è±†å³¶"], hotelIdx: 7 },
            { date: "05/07", title: "å°è±†å³¶å…¨æ—¥", items: ["å¯’éœæºª", "é‡å²©", "é†¬æ²¹ç´€å¿µé¤¨", "ä¸¸é¾œåŸ"], hotelIdx: 8 },
            { date: "05/08", title: "é¦™å·ç§˜å¢ƒå·¡ç¦®", items: ["é‡‘åˆ€æ¯”ç¾…å®®", "é›²é‚Šå¯º", "çˆ¶æ¯æ¿±æµ·å²¸"], hotelIdx: 9 },
            { date: "05/09", title: "æ·¡è·¯å³¶ â” ç¥æˆ¶", items: ["æ·¡è·¯å¤¢èˆå°", "äºŒæ¬¡å…ƒä¹‹æ£®", "æ˜çŸ³æµ·å³½å…¬åœ’"], hotelIdx: 10 },
            { date: "05/10", title: "æ•£æœƒ", items: ["ç¥æˆ¶æœ€å¾Œå·¡ç¦®", "å‰å¾€æ©Ÿå ´/æ–°å¤§é˜ª", "å›å®¶"], hotelIdx: -1 }
        ],
        fixedExpenses: [
            { title: "å®£ä½‘ (å«æ–°å¹¹ç·š)", amount: 188676 },
            { title: "ç¾©æ™º", amount: 142783 },
            { title: "æµ·å¤–äººå“¡", amount: 163676 }
        ],
        members: [],
        expenses: []
    };
    
    const hotelDB = [
        {date:"4/29", name:"ERA ç¥æˆ¶ä¸‰å®®", price:23400, url:"https://travel.rakuten.co.jp/HOTEL/167683/167683.html"},
        {date:"4/30", name:"æ±æ¨ªINN å¾·å³¶", price:22052, url:"https://travel.rakuten.co.jp/HOTEL/68537/68537.html"},
        {date:"5/1", name:"ç¥–è°·è¦³å…‰æ—…é¤¨", price:40000, url:"https://travel.rakuten.co.jp/HOTEL/142344/142344.html"},
        {date:"5/2", name:"æ˜Ÿç¾…å››ä¸‡å", price:116600, url:"https://travel.rakuten.co.jp/HOTEL/70733/70733.html"},
        {date:"5/3", name:"æ„›çµ²éœ²æ¾å±±", price:36120, url:"https://travel.rakuten.co.jp/HOTEL/13883/13883.html"},
        {date:"5/4", name:"æ±æ¨ªINN ç¦å±±", price:29700, url:"https://travel.rakuten.co.jp/HOTEL/151477/151477.html"},
        {date:"5/5", name:"ãã‚ŒãŸã‘å²¡å±±", price:22680, url:"https://travel.rakuten.co.jp/HOTEL/158311/158311.html"},
        {date:"5/6", name:"ã‚ªãƒªãƒ“ã‚¢ãƒ³å°è±†å³¶", price:68500, url:"https://www.jalan.net/yad307396/"},
        {date:"5/7", name:"APA ä¸¸é¾œ", price:22400, url:"https://travel.rakuten.co.jp/HOTEL/80598/80598.html"},
        {date:"5/8", name:"ã‚¢ãƒ†ãƒ¼ãƒŠæµ·æœˆ", price:18000, url:"https://travel.rakuten.co.jp/HOTEL/54177/54177.html"},
        {date:"5/9", name:"æ±æ¨ªINN ç¥æˆ¶", price:31680, url:"https://travel.rakuten.co.jp/HOTEL/108407/108407.html"}
    ];

    let appData = JSON.parse(JSON.stringify(defaultData));

    // --- 1. é›²ç«¯èˆ‡åŠ å¯†æ ¸å¿ƒé‚è¼¯ ---
    async function initCloudSync() {
        const inputPwd = document.getElementById('secret-password').value;
        if(!inputPwd) { showLoginMsg("è«‹è¼¸å…¥å¯†ç¢¼"); return; }
        
        PASSWORD = inputPwd;
        
        // UI åˆ‡æ›
        document.getElementById('login-box').classList.add('hidden');
        document.getElementById('loading-spinner').classList.remove('hidden');

        try {
            // è®€å–é›²ç«¯è³‡æ–™
            const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                headers: { 'X-Master-Key': API_KEY }
            });
            
            if (!response.ok) throw new Error("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API Key");
            
            const result = await response.json();
            const encryptedStr = result.record.data; // å‡è¨­å­˜çš„æ˜¯ { data: "åŠ å¯†å­—ä¸²" }
            
            if (!encryptedStr) {
                // å¦‚æœé›²ç«¯æ˜¯ç©ºçš„ (ç¬¬ä¸€æ¬¡ä½¿ç”¨)ï¼Œç›´æ¥ä½¿ç”¨é è¨­è³‡æ–™ä¸¦ä¸Šå‚³
                console.log("é›²ç«¯ç„¡è³‡æ–™ï¼Œåˆå§‹åŒ–ä¸­...");
                updateStatus("åˆå§‹åŒ–é›²ç«¯è³‡æ–™...");
                await saveToCloud();
                closeOverlay();
                renderAll();
                return;
            }

            // è§£å¯†
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedStr, PASSWORD);
                const decryptedData = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                appData = decryptedData;
                updateStatus("åŒæ­¥å®Œæˆ");
                closeOverlay();
                renderAll();
            } catch (e) {
                // è§£å¯†å¤±æ•—é€šå¸¸ä»£è¡¨å¯†ç¢¼éŒ¯èª¤
                throw new Error("å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•è§£å¯†è³‡æ–™");
            }

        } catch (error) {
            document.getElementById('loading-spinner').classList.add('hidden');
            document.getElementById('login-box').classList.remove('hidden');
            showLoginMsg(error.message);
        }
    }

    async function saveToCloud() {
        updateStatus("åŠ å¯†ä¸Šå‚³ä¸­...");
        try {
            // åŠ å¯†
            const encryptedStr = CryptoJS.AES.encrypt(JSON.stringify(appData), PASSWORD).toString();
            
            // ä¸Šå‚³
            await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': API_KEY
                },
                body: JSON.stringify({ data: encryptedStr })
            });
            updateStatus("å·²å„²å­˜è‡³é›²ç«¯", true);
        } catch (error) {
            updateStatus("ä¸Šå‚³å¤±æ•—!", false, true);
            alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
        }
    }

    function showLoginMsg(msg) {
        document.getElementById('login-msg').innerText = msg;
    }

    function closeOverlay() {
        document.getElementById('loading-overlay').style.opacity = '0';
        setTimeout(() => document.getElementById('loading-overlay').remove(), 500);
    }

    function updateStatus(msg, success = true, error = false) {
        const el = document.getElementById('cloud-status');
        let icon = success ? '<i class="fas fa-check-circle text-green-400"></i>' : '<i class="fas fa-sync fa-spin text-blue-400"></i>';
        if(error) icon = '<i class="fas fa-exclamation-triangle text-red-400"></i>';
        el.innerHTML = `${icon} ${msg}`;
    }

    // --- 2. æ‡‰ç”¨ç¨‹å¼é‚è¼¯ (è¡Œç¨‹æ‹–æ›³) ---
    function renderItinerary() {
        const list = document.getElementById('itinerary-list');
        list.innerHTML = appData.tripData.map((day, dIdx) => {
            const hotelInfo = day.hotelIdx >= 0 ? hotelDB[day.hotelIdx] : { name: "æº«æš–çš„å®¶", url: "#" };
            const itemsHtml = day.items.map((item, iIdx) => {
                let navLink = "";
                if (iIdx > 0) {
                    const prevItem = day.items[iIdx-1];
                    const mapUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(prevItem)}&destination=${encodeURIComponent(item)}&travelmode=driving`;
                    navLink = `<div class="ml-8 pl-4 border-l-2 border-dashed border-indigo-200 py-2"><a href="${mapUrl}" target="_blank" class="inline-flex items-center text-[10px] text-indigo-500 bg-indigo-50 px-2 py-1 rounded-full"><i class="fas fa-route mr-1"></i>å°èˆª</a></div>`;
                }
                return `
                ${navLink}
                <div class="draggable-item bg-white p-3 rounded-lg shadow-sm border border-slate-100 flex justify-between items-center z-10" draggable="true" data-didx="${dIdx}" data-iidx="${iIdx}">
                    <div class="flex items-center gap-3 flex-grow"><i class="fas fa-grip-vertical text-slate-300"></i><span onclick="editNode(${dIdx}, ${iIdx})" class="editable font-medium text-slate-600 flex-grow">${item}</span></div>
                    <div class="flex space-x-1"><button onclick="deleteNode(${dIdx}, ${iIdx})" class="p-2 text-red-300"><i class="fas fa-times"></i></button></div>
                </div>`
            }).join('');

            return `
            <div class="relative pb-2">
                <div class="flex items-center mb-1 sticky top-16 bg-slate-100 z-20 py-2">
                    <span class="bg-slate-800 text-white text-[10px] px-2 py-1 rounded font-bold mr-2">${day.date}</span>
                    <h2 onclick="editTitle(${dIdx})" class="editable text-lg font-black text-slate-800 flex-grow px-1">${day.title}</h2>
                </div>
                <div class="space-y-1 pl-2 border-l-2 border-slate-200 ml-2 relative">
                    ${itemsHtml}
                    <div class="bg-orange-50 p-3 rounded-lg flex justify-between items-center text-xs font-bold text-orange-800 border border-orange-100 mt-2 z-10 relative"><span><i class="fas fa-bed mr-2"></i>${hotelInfo.name}</span>${hotelInfo.url!=='#'?`<a href="${hotelInfo.url}" target="_blank" class="bg-white px-3 py-1 rounded shadow-sm">è¨‚æˆ¿</a>`:''}</div>
                </div>
            </div>`
        }).join('');
        setupDragAndDrop();
    }

    // æ‹–æ›³ç›¸é—œ
    let dragSrcEl = null;
    let dragSrcDIdx = null;
    let dragSrcIIdx = null;

    function setupDragAndDrop() {
        document.querySelectorAll('.draggable-item').forEach(item => {
            item.addEventListener('dragstart', function(e) {
                this.classList.add('dragging'); dragSrcEl=this;
                dragSrcDIdx=parseInt(this.dataset.didx); dragSrcIIdx=parseInt(this.dataset.iidx);
            });
            item.addEventListener('dragover', e => e.preventDefault());
            item.addEventListener('dragend', function() { this.classList.remove('dragging'); });
            item.addEventListener('drop', function(e) {
                e.stopPropagation();
                const target = e.target.closest('.draggable-item');
                if (dragSrcEl !== target && target) {
                    const tDIdx=parseInt(target.dataset.didx); const tIIdx=parseInt(target.dataset.iidx);
                    if (dragSrcDIdx === tDIdx) {
                        const items = appData.tripData[dragSrcDIdx].items;
                        const [moved] = items.splice(dragSrcIIdx, 1);
                        items.splice(tIIdx, 0, moved);
                        renderItinerary(); saveToCloud();
                    } else alert("åƒ…æ”¯æ´åŒæ—¥æ’åº");
                }
            });
        });
    }

    function editTitle(i){const v=prompt("ä¿®æ”¹:",appData.tripData[i].title);if(v){appData.tripData[i].title=v;renderItinerary();saveToCloud();}}
    function editNode(d,i){const v=prompt("ä¿®æ”¹:",appData.tripData[d].items[i]);if(v){appData.tripData[d].items[i]=v;renderItinerary();saveToCloud();}}
    function deleteNode(d,i){if(confirm("åˆªé™¤?")){appData.tripData[d].items.splice(i,1);renderItinerary();saveToCloud();}}
    function addNodePrompt(){
        const d=prompt("æ—¥æœŸ (ä¾‹ 05/01):"); const i=prompt("æ™¯é»:");
        const day=appData.tripData.find(x=>x.date===d);
        if(day&&i){day.items.push(i);renderItinerary();saveToCloud();}else{alert("æ‰¾ä¸åˆ°æ—¥æœŸ");}
    }

    // --- 3. é ç®—èˆ‡è¨˜å¸³ ---
    function renderFixedBudget(){
        document.getElementById('fixed-expense-list').innerHTML=appData.fixedExpenses.map((item,idx)=>`
            <div class="flex justify-between items-center bg-slate-50 p-3 rounded-lg border border-slate-100">
                <span onclick="editFixed(${idx},'title')" class="editable text-sm font-bold text-slate-700">${item.title}</span>
                <div class="flex items-center"><span onclick="editFixed(${idx},'amount')" class="editable font-mono font-bold text-indigo-600 mr-3">Â¥${item.amount.toLocaleString()}</span><button onclick="deleteFixed(${idx})" class="text-slate-300 text-xs"><i class="fas fa-trash"></i></button></div>
            </div>`).join('');
    }
    function editFixed(i,f){ if(f==='title'){const v=prompt("ä¿®æ”¹:",appData.fixedExpenses[i].title);if(v)appData.fixedExpenses[i].title=v;}else{const v=parseInt(prompt("é‡‘é¡:"));if(!isNaN(v))appData.fixedExpenses[i].amount=v;} renderFixedBudget();saveToCloud();}
    function deleteFixed(i){if(confirm("åˆªé™¤?")){appData.fixedExpenses.splice(i,1);renderFixedBudget();saveToCloud();}}
    function addFixedExpense(){const t=prompt("é …ç›®:");const a=parseInt(prompt("é‡‘é¡:"));if(t&&!isNaN(a)){appData.fixedExpenses.push({title:t,amount:a});renderFixedBudget();saveToCloud();}}
    
    function renderHotelTable(){
        document.getElementById('hotel-list-body').innerHTML=hotelDB.map(h=>`<tr class="border-b border-orange-100"><td class="p-2"><div class="font-bold text-slate-600">${h.date}</div><a href="${h.url}" target="_blank" class="text-indigo-600 text-[10px]">${h.name}</a></td><td class="p-2 text-right font-mono font-bold text-slate-500">Â¥${h.price.toLocaleString()}</td></tr>`).join('');
    }

    function addMember(){const n=document.getElementById('new-member-name').value.trim();if(n&&!appData.members.includes(n)){appData.members.push(n);document.getElementById('new-member-name').value='';renderLedgerUI();saveToCloud();}}
    function renderLedgerUI(){document.getElementById('member-tags').innerHTML=appData.members.map(m=>`<span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full text-[10px] font-bold">${m}</span>`).join('');calculateSettlement();}
    
    function renderLedgerTable(){
        const con=document.getElementById('expense-container'); if(appData.expenses.length===0){con.innerHTML=`<div class="text-center text-slate-300 py-10">å°šç„¡ç´€éŒ„</div>`;return;}
        const grp=appData.expenses.reduce((g,i,idx)=>{if(!g[i.date])g[i.date]=[];g[i.date].push({...i,oid:idx});return g;},{});
        con.innerHTML=Object.keys(grp).sort().map(d=>{
            let tot=0;
            const items=grp[d].map(i=>{ tot+=i.amount; return `<div class="flex justify-between items-center p-3 border-b border-slate-100 bg-white last:border-0"><div><div class="font-bold text-sm text-slate-700">${i.desc}</div><div class="text-[10px] text-slate-400">${i.payer} å¢Šä»˜ (${i.splitWith.length}äºº)</div></div><div class="text-right"><div class="font-mono font-bold text-indigo-600">Â¥${i.amount.toLocaleString()}</div><button onclick="delExp(${i.oid})" class="text-slate-200 hover:text-red-400 text-xs"><i class="fas fa-trash"></i></button></div></div>`;}).join('');
            return `<div class="mb-4 rounded-xl overflow-hidden border border-slate-200 shadow-sm"><div class="bg-slate-50 p-2 flex justify-between items-center text-xs font-bold text-slate-600"><span>${d}</span><span>å°è¨ˆ Â¥${tot.toLocaleString()}</span></div>${items}</div>`;
        }).join('');
    }
    
    function saveExpense(){
        const dr=document.getElementById('input-date').value; const desc=document.getElementById('input-desc').value; const amt=parseInt(document.getElementById('input-amount').value); const payer=document.getElementById('input-payer').value;
        const sw=Array.from(document.querySelectorAll('.split-check:checked')).map(c=>c.value);
        if(!dr||isNaN(amt)||amt<=0||sw.length===0)return alert("è«‹å¡«å¯«å®Œæ•´");
        const d=new Date(dr); const ds=`${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
        appData.expenses.push({date:ds,desc,amount:amt,payer,splitWith:sw});
        document.getElementById('expense-modal').classList.add('hidden'); renderLedgerTable();calculateSettlement();saveToCloud();
    }
    function delExp(i){if(confirm("åˆªé™¤?")){appData.expenses.splice(i,1);renderLedgerTable();calculateSettlement();saveToCloud();}}
    
    function calculateSettlement(){
        if(appData.members.length===0)return;
        let bal={};appData.members.forEach(m=>bal[m]=0);
        appData.expenses.forEach(e=>{const s=e.amount/e.splitWith.length;bal[e.payer]+=e.amount;e.splitWith.forEach(p=>{if(bal.hasOwnProperty(p))bal[p]-=s;});});
        let db=[],cr=[]; for(const[n,v]of Object.entries(bal)){const r=Math.round(v); if(r<-1)db.push({n,v:r});if(r>1)cr.push({n,v:r});}
        db.sort((a,b)=>a.v-b.v);cr.sort((a,b)=>b.v-a.v);
        let h='',d=0,c=0;
        while(d<db.length&&c<cr.length){
            let a=Math.min(Math.abs(db[d].v),cr[c].v);
            if(a>0)h+=`<div class="flex justify-between items-center bg-white p-2 rounded border border-slate-200 mb-1"><div class="flex items-center space-x-2"><span class="font-bold text-slate-700 bg-slate-100 px-2 rounded">${db[d].n}</span><i class="fas fa-arrow-right text-slate-300 text-[10px]"></i><span class="font-bold text-indigo-700 bg-indigo-50 px-2 rounded">${cr[c].n}</span></div><span class="font-black text-indigo-600">Â¥${a.toLocaleString()}</span></div>`;
            db[d].v+=a;cr[c].v-=a; if(Math.abs(db[d].v)<1)d++;if(cr[c].v<1)c++;
        }
        document.getElementById('settlement-result').innerHTML=h||'<div class="text-center text-slate-400">å¸³ç›®å·²çµæ¸…</div>';
    }

    function openExpenseModal(){
        if(appData.members.length<2)return alert("è«‹å…ˆæ–°å¢è‡³å°‘å…©ä½æˆå“¡");
        document.getElementById('input-date').valueAsDate=new Date(); document.getElementById('input-desc').value='';document.getElementById('input-amount').value='';
        document.getElementById('input-payer').innerHTML=appData.members.map(m=>`<option value="${m}">${m}</option>`).join('');
        document.getElementById('input-split-container').innerHTML=appData.members.map(m=>`<label class="flex items-center bg-slate-50 p-2 rounded border cursor-pointer"><input type="checkbox" value="${m}" checked class="accent-indigo-600 split-check mr-2"><span class="text-xs">${m}</span></label>`).join('');
        document.getElementById('expense-modal').classList.remove('hidden');
    }
    function toggleAllSplit(){const c=document.querySelectorAll('.split-check');const a=Array.from(c).every(x=>x.checked);c.forEach(x=>x.checked=!a);}
    function switchTab(t){document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));document.getElementById(`${t}-page`).classList.add('active');['itinerary','finance','ledger'].forEach(x=>{document.getElementById(`tab-${x}`).className=x===t?"flex-1 py-2 text-sm font-bold rounded bg-white text-slate-900 shadow-sm transition-all":"flex-1 py-2 text-sm font-bold rounded text-slate-400 hover:bg-slate-700 hover:text-white transition-all";});}
    function renderAll(){renderItinerary();renderFixedBudget();renderHotelTable();renderLedgerUI();renderLedgerTable();}

</script>
</body>
</html>