<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JourneyAPP v21</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        .draggable-item { user-select: none; transition: all 0.2s; cursor: grab; }
        .draggable-item:active { cursor: grabbing; transform: scale(1.01); }
        .dragging { opacity: 0.5; border: 2px dashed #4f46e5; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .editable:hover { background-color: #f0f9ff; color: #0284c7; cursor: pointer; border-radius: 4px; padding: 0 4px;}
        .date-badge:hover { background-color: #475569; cursor: pointer; transform: scale(1.05); transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .budget-table th { font-size: 0.7rem; text-transform: uppercase; padding: 8px; }
        .budget-table td { font-size: 0.8rem; padding: 8px; border-bottom: 1px solid #f1f5f9; }
        #app-main-title:hover { opacity: 0.8; cursor: pointer; text-decoration: underline; text-decoration-style: dashed; }
        .ledger-row:hover { background-color: #f8fafc; cursor: pointer; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 pb-32 overflow-y-scroll">

    <div id="loading-overlay">
        <div id="login-box" class="bg-white text-slate-900 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">
            <div class="mb-4 text-5xl">ğŸš</div>
            <h2 class="text-2xl font-black mb-2 text-indigo-900">JourneyAPP</h2>
            <p class="text-xs text-slate-500 mb-6">v21.0 é ç®—æ•´åˆç‰ˆ</p>
            <input type="password" id="secret-password" placeholder="è¼¸å…¥å¯†ç¢¼..." class="w-full border-2 border-slate-200 rounded-xl p-3 text-lg font-bold mb-4 focus:border-indigo-500 outline-none text-center">
            <button onclick="initCloudSync()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition-all shadow-lg active:scale-95">
                <i class="fas fa-unlock-alt mr-2"></i>è§£é–åŒæ­¥
            </button>
            <div id="login-msg" class="mt-4 text-red-500 text-xs font-bold h-4"></div>
        </div>
        <div id="loading-spinner" class="hidden text-center">
            <i class="fas fa-circle-notch fa-spin text-5xl text-indigo-400 mb-4"></i>
            <p class="font-bold tracking-widest animate-pulse text-sm">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</p>
        </div>
    </div>

    <header class="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-md">
        <div class="flex justify-between items-center mb-2">
            <div>
                <h1 id="app-main-title" onclick="editAppTitle()" class="text-lg font-black italic tracking-wider" title="é»æ“Šä¿®æ”¹æ¨™é¡Œ">SHIKOKU 2026</h1>
                <p id="cloud-status" class="text-slate-400 text-[10px] mt-1 flex items-center gap-1"><i class="fas fa-wifi"></i> ç­‰å¾…é€£ç·š...</p>
            </div>
            <div class="text-[10px] font-bold border border-slate-600 px-2 py-1 rounded bg-slate-800">v21.0</div>
        </div>
        <div class="flex space-x-1 bg-slate-800 p-1 rounded-lg">
            <button onclick="switchTab('itinerary')" id="tab-itinerary" class="flex-1 py-2 text-sm font-bold rounded bg-white text-slate-900 shadow-sm transition-all">è¡Œç¨‹</button>
            <button onclick="switchTab('finance')" id="tab-finance" class="flex-1 py-2 text-sm font-bold rounded text-slate-400 hover:bg-slate-700 hover:text-white transition-all">é ç®—</button>
            <button onclick="switchTab('ledger')" id="tab-ledger" class="flex-1 py-2 text-sm font-bold rounded text-slate-400 hover:bg-slate-700 hover:text-white transition-all">è¨˜å¸³</button>
        </div>
    </header>

    <main id="itinerary-page" class="tab-content active px-4 py-6">
        <div class="text-[10px] text-slate-400 mb-4 text-center bg-white py-2 rounded-lg shadow-sm border border-slate-100">
            <i class="fas fa-magic mr-1 text-indigo-500"></i>æç¤ºï¼šè‹¥å°‡æŸå¤©çš„è¡Œç¨‹å…¨éƒ¨åˆªé™¤ï¼Œè©²æ—¥æœŸä¹Ÿæœƒè‡ªå‹•ç§»é™¤ã€‚
        </div>
        <div id="itinerary-list" class="space-y-8"></div>
        <div class="fixed bottom-6 right-6 z-40">
             <button onclick="openItineraryModal('add')" class="bg-indigo-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center border-2 border-white text-xl hover:scale-105 transition-transform">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </main>

    <main id="finance-page" class="tab-content px-4 py-6 space-y-6">
        <div class="bg-white rounded-xl p-4 shadow-sm border border-indigo-100">
            <h3 class="font-bold text-xs text-indigo-900 mb-2 uppercase flex justify-between items-center">
                <span><i class="fas fa-users mr-1"></i>äººå“¡åå–®</span>
                <span id="member-count-finance" class="bg-indigo-100 text-indigo-600 px-2 rounded-full text-[10px]">0äºº</span>
            </h3>
            <div class="flex gap-2 mb-3">
                <input id="finance-new-member" type="text" placeholder="è¼¸å…¥å§“å" class="bg-slate-50 border border-slate-200 rounded px-2 py-1 text-xs flex-grow focus:outline-none focus:border-indigo-500">
                <button onclick="addMemberFromFinance()" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs">æ–°å¢</button>
            </div>
            <div id="member-tags-finance" class="flex flex-wrap gap-2"></div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-slate-50 p-4 border-b flex justify-between items-center cursor-pointer" onclick="document.getElementById('car-details').classList.toggle('hidden')">
                <div class="flex items-center"><i class="fas fa-car-side text-indigo-600 mr-2"></i><span class="font-bold text-sm">Toyota Rent-A-Car</span></div>
                <div class="text-right"><span class="font-black text-indigo-600 text-sm block">Â¥137,679</span></div>
            </div>
            <div id="car-details" class="p-4 text-xs space-y-2 hidden border-t">
                <p><b>é ç´„è™Ÿç¢¼:</b> 99991680900 (W1 Class)</p>
                <p><b>å–è»Š:</b> 04/29 14:30 æ–°å¤§é˜ªé§…å‰åº—</p>
                <p><b>é‚„è»Š:</b> 05/10 20:00 æ–°å¤§é˜ªé§…å‰åº—</p>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-orange-100 overflow-hidden">
            <div class="p-3 bg-orange-50 border-b border-orange-100 flex justify-between items-center">
                <span class="font-bold text-orange-800 text-sm"><i class="fas fa-hotel mr-2"></i>ä½å®¿é ç®—</span>
                <div>
                    <span id="hotel-total" class="text-xs bg-white text-orange-600 px-2 py-1 rounded shadow-sm mr-2 font-bold">Â¥0</span>
                    <button onclick="openHotelModal()" class="text-xs bg-orange-600 text-white px-2 py-1 rounded shadow hover:bg-orange-700"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="overflow-x-auto"><table class="w-full text-left budget-table whitespace-nowrap"><thead class="bg-orange-100 text-orange-800"><tr><th>æ—¥æœŸ/é£¯åº—</th><th class="text-center">åˆ†æ”¤</th><th class="text-right">æ¯äºº</th><th class="text-right">ç¸½åƒ¹</th><th></th></tr></thead><tbody id="hotel-list-body"></tbody></table></div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-3 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                <span class="font-bold text-slate-700 text-sm"><i class="fas fa-bus mr-2"></i>å…¶é¤˜é ç®—</span>
                <div>
                    <span id="other-total" class="text-xs bg-white text-slate-600 px-2 py-1 rounded shadow-sm mr-2 font-bold">Â¥0</span>
                    <button onclick="openOtherBudgetModal('add')" class="text-xs bg-slate-600 text-white px-2 py-1 rounded shadow hover:bg-slate-700"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="overflow-x-auto"><table class="w-full text-left budget-table whitespace-nowrap"><thead class="bg-slate-100 text-slate-600"><tr><th>é …ç›®</th><th class="text-center">åˆ†æ”¤</th><th class="text-right">æ¯äºº</th><th class="text-right">ç¸½åƒ¹</th><th></th></tr></thead><tbody id="other-expense-body"></tbody></table></div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-indigo-500">
            <h2 class="font-bold text-sm text-slate-700 mb-3"><i class="fas fa-chart-pie mr-2 text-indigo-500"></i>å€‹äººé ä¼°ç¸½æ”¯å‡º</h2>
            <div id="budget-summary-list" class="space-y-2"></div>
        </div>
    </main>

    <main id="ledger-page" class="tab-content px-4 py-6 space-y-6">
        <div class="bg-slate-50 rounded-xl p-3 border border-slate-200 flex justify-between items-center">
            <h3 class="font-bold text-xs text-slate-400 uppercase">äººå“¡åå–® (åŒæ­¥è‡ªé ç®—é )</h3>
            <button onclick="switchTab('finance')" class="text-[10px] text-indigo-500 border border-indigo-200 px-2 rounded">å‰å¾€ç·¨è¼¯</button>
        </div>
        <div id="member-tags-ledger" class="flex flex-wrap gap-2"></div>
        <div class="bg-gradient-to-br from-indigo-50 to-white rounded-xl p-4 border border-indigo-100 shadow-sm">
            <h3 class="font-bold text-xs text-indigo-500 mb-2"><i class="fas fa-calculator mr-1"></i>è¨˜å¸³çµç®—å»ºè­°</h3>
            <div id="settlement-result" class="text-xs font-medium text-slate-700 space-y-1"></div>
        </div>
        <div id="expense-container" class="pb-20"></div>
        
        <div class="fixed bottom-6 left-1/2 -translate-x-1/2 z-40 w-full flex justify-center pointer-events-none">
            <button onclick="openExpenseModal('add')" class="pointer-events-auto bg-slate-900 text-white px-8 py-3 rounded-full font-bold shadow-2xl flex items-center border-4 border-slate-100 transform active:scale-95 transition-all">
                <i class="fas fa-receipt mr-2"></i>è¨˜ä¸€ç­†
            </button>
        </div>
    </main>

    <div id="hotel-modal" class="fixed inset-0 bg-slate-900/80 z-[80] hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md sm:rounded-2xl rounded-t-2xl overflow-hidden shadow-2xl p-5">
            <h3 class="font-bold text-lg mb-4 text-orange-700">æ–°å¢ä½å®¿è³‡è¨Š</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-bold text-slate-400">å…¥ä½æ—¥æœŸ</label><input type="date" id="hotel-input-date" class="w-full bg-slate-50 border rounded-lg p-2.5 text-sm font-bold text-slate-700 mt-1"></div>
                    <div><label class="text-[10px] font-bold text-slate-400">ç¸½é‡‘é¡ (JPY)</label><input type="number" id="hotel-input-price" class="w-full bg-slate-50 border rounded-lg p-2.5 text-sm font-black text-orange-600 mt-1" placeholder="0"></div>
                </div>
                <div><label class="text-[10px] font-bold text-slate-400">é£¯åº—åç¨±</label><input type="text" id="hotel-input-name" class="w-full bg-slate-50 border rounded-lg p-2.5 text-sm font-bold mt-1" placeholder="ä¾‹å¦‚: æ±æ©«INN"></div>
                <div><label class="text-[10px] font-bold text-slate-400">è¨‚æˆ¿é€£çµ (URL)</label><input type="url" id="hotel-input-url" class="w-full bg-slate-50 border rounded-lg p-2.5 text-sm text-blue-600 mt-1" placeholder="https://..."></div>
                <button onclick="saveHotel()" class="w-full bg-orange-600 text-white py-3 rounded-lg font-bold shadow-lg">æ–°å¢ä½å®¿</button>
                <button onclick="document.getElementById('hotel-modal').classList.add('hidden')" class="w-full bg-slate-100 text-slate-500 py-3 rounded-lg font-bold mt-2">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="other-budget-modal" class="fixed inset-0 bg-slate-900/80 z-[80] hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md sm:rounded-2xl rounded-t-2xl overflow-hidden shadow-2xl p-5">
            <h3 id="other-budget-title" class="font-bold text-lg mb-4 text-slate-700">æ–°å¢é ç®—é …ç›®</h3>
            <div class="space-y-4">
                <div><label class="text-[10px] font-bold text-slate-400">é …ç›®åç¨±</label><input type="text" id="ob-title" class="w-full bg-slate-50 border rounded-lg p-2.5 text-sm font-bold mt-1" placeholder="ä¾‹å¦‚: ç§Ÿè»Šè²»"></div>
                <div><label class="text-[10px] font-bold text-slate-400">ç¸½é‡‘é¡ (JPY)</label><input type="number" id="ob-amount" class="w-full bg-slate-50 border rounded-lg p-2.5 text-sm font-black text-slate-700 mt-1" placeholder="0"></div>
                
                <div>
                    <div class="flex justify-between items-end mb-2">
                        <label class="text-[10px] font-bold text-slate-400">åˆ†æ”¤äººå“¡</label>
                        <button onclick="toggleOtherBudgetSplit()" class="text-[10px] text-indigo-500 font-bold">å…¨é¸/å–æ¶ˆ</button>
                    </div>
                    <div id="ob-split-container" class="grid grid-cols-2 gap-2 max-h-32 overflow-y-auto p-1 bg-slate-50 rounded-lg border border-slate-200"></div>
                </div>

                <button onclick="saveOtherBudget()" class="w-full bg-slate-700 text-white py-3 rounded-lg font-bold shadow-lg">å„²å­˜ç¢ºèª</button>
                <button onclick="document.getElementById('other-budget-modal').classList.add('hidden')" class="w-full bg-slate-100 text-slate-500 py-3 rounded-lg font-bold mt-2">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="itinerary-modal" class="fixed inset-0 bg-slate-900/80 z-[80] hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm sm:rounded-2xl rounded-t-2xl overflow-hidden shadow-2xl p-5">
            <h3 id="itinerary-modal-title" class="font-bold text-lg mb-4 text-slate-700">æ–°å¢è¡Œç¨‹ç¯€é»</h3>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-400">é¸æ“‡æ—¥æœŸ</label><input type="date" id="iti-date" class="w-full bg-slate-50 border rounded-lg p-3 text-slate-700 font-bold mt-1"></div>
                <div id="iti-name-group"><label class="text-xs font-bold text-slate-400">æ™¯é»åç¨±</label><input type="text" id="iti-name" class="w-full bg-slate-50 border rounded-lg p-3 mt-1" placeholder="ä¾‹å¦‚: é‡‘åˆ€æ¯”ç¾…å®®"></div>
                <button onclick="saveItineraryNode()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow-lg">å„²å­˜ç¢ºèª</button>
                <button onclick="document.getElementById('itinerary-modal').classList.add('hidden')" class="w-full bg-slate-100 text-slate-500 py-3 rounded-lg font-bold mt-2">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="member-select-modal" class="fixed inset-0 bg-slate-900/80 z-[70] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-xl overflow-hidden shadow-2xl p-4">
            <h3 class="font-bold text-slate-700 mb-3 text-center">é¸æ“‡åˆ†æ”¤äººå“¡</h3>
            <div id="member-checkbox-list" class="grid grid-cols-2 gap-2 mb-4 max-h-48 overflow-y-auto"></div>
            <div class="flex gap-2">
                <button onclick="document.getElementById('member-select-modal').classList.add('hidden')" class="flex-1 bg-slate-100 text-slate-600 py-2 rounded-lg text-xs font-bold">å–æ¶ˆ</button>
                <button id="save-members-btn" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg text-xs font-bold">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div id="expense-modal" class="fixed inset-0 bg-slate-900/80 z-[60] hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md sm:rounded-2xl rounded-t-2xl overflow-hidden shadow-2xl p-5">
            <div class="flex justify-between items-center mb-4">
                <h3 id="expense-modal-title" class="font-bold text-slate-700">æ–°å¢æ¶ˆè²»</h3>
                <button id="expense-delete-btn" onclick="deleteExpenseFromModal()" class="text-red-400 text-xs font-bold hidden"><i class="fas fa-trash mr-1"></i>åˆªé™¤æ­¤ç­†</button>
            </div>
            <div class="space-y-3">
                <div class="grid grid-cols-3 gap-2">
                    <input type="date" id="input-date" class="col-span-1 bg-slate-50 border rounded p-2 text-sm">
                    <input type="text" id="input-desc" placeholder="é …ç›®" class="col-span-2 bg-slate-50 border rounded p-2 text-sm font-bold">
                </div>
                <div class="relative">
                    <span class="absolute left-3 top-2 text-slate-400">Â¥</span>
                    <input type="number" id="input-amount" placeholder="é‡‘é¡" class="w-full bg-slate-50 border rounded p-2 pl-6 text-lg font-black text-indigo-600">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="text-[10px] text-slate-400">ä»˜æ¬¾äºº</label><select id="input-payer" class="w-full bg-slate-50 border rounded p-2 text-xs font-bold"></select></div>
                    <div><label class="text-[10px] text-slate-400">åˆ†æ”¤</label><button onclick="toggleAllSplit()" class="w-full bg-slate-100 border rounded p-2 text-xs text-indigo-600">å…¨é¸/å–æ¶ˆ</button></div>
                </div>
                <div id="input-split-container" class="grid grid-cols-3 gap-2 max-h-24 overflow-y-auto"></div>
                <button onclick="saveExpense()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow mt-2">å„²å­˜ä¸¦ä¸Šå‚³</button>
                <button onclick="document.getElementById('expense-modal').classList.add('hidden')" class="w-full bg-slate-100 text-slate-500 py-3 rounded-lg font-bold mt-2">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

<script>
    // ==========================================
    // âš™ï¸ è¨­å®šå€åŸŸ
    // ==========================================
    const BIN_ID = '6979a2a5ae596e708ffcaa08'; 
    const API_KEY = '$2a$10$riptLWHFddiwJudT1.BkMuiFmirkcbziLr7ytSl6DrydUhB/XPsvG'; 
    // ==========================================
    
    let PASSWORD = ''; 
    const defaultData = {
        appTitle: "SHIKOKU 2026",
        tripData: [
            { date: "04/29", title: "é›†åˆèˆ‡æ‘©è€¶å±±å¤œæ™¯", items: ["æ–°å¤§é˜ª 14:00 é›†åˆ", "æ‘©è€¶å±±å¤œæ™¯", "å±…é…’å±‹æ™šé¤"], hotelIdx: 0 },
            { date: "04/30", title: "ç¥æˆ¶ â” å¾·å³¶", items: ["æ˜çŸ³å¤§æ©‹è¦‹å­¸", "åŒ—é‡ç•°äººé¤¨", "æ·¡è·¯æœå‹™å€", "å¾·å³¶çœ‰å±±"], hotelIdx: 1 },
            { date: "05/01", title: "é³´é–€èˆ‡ç¥–è°·æº«æ³‰", items: ["å¤§é³´é–€æ©‹ æ¸¦ä¹‹é“", "é³´é–€å±•æœ›å°", "ç¥–è°·æº«æ³‰æ—…é¤¨"], hotelIdx: 2 },
            { date: "05/02", title: "å¤§æ­¥å±èˆ‡å¥§ç¥–è°·", items: ["å¤§æ­¥å±å°æ­¥å±", "å¥§ç¥–è°·äºŒé‡è—¤è”“æ©‹", "å››è¬åå¤©æ–‡é¤¨"], hotelIdx: 3 },
            { date: "05/03", title: "å››è¬å â” æ¾å±±", items: ["å››è¬åå·éŠè¦½", "é¾æ²³æ´", "æ¾å±±åŸ"], hotelIdx: 4 },
            { date: "05/04", title: "å³¶æ³¢æµ·é“ â” å°¾é“", items: ["è¡ä»Šæ²»", "å³¶æ³¢æµ·é“è·¨æµ·", "å°¾é“æ•£ç­–"], hotelIdx: 5 },
            { date: "05/05", title: "å°¾é“ â” å²¡å±±", items: ["å°¾é“å•†åº—è¡—", "å€‰æ•·ç¾è§€åœ°å€", "å²¡å±±åŸ"], hotelIdx: 6 },
            { date: "05/06", title: "å²¡å±± â” å°è±†å³¶", items: ["å²¡å±±å¤©ä½¿ä¹‹è·¯", "æ­èˆ¹ç›´å¥”å°è±†å³¶"], hotelIdx: 7 },
            { date: "05/07", title: "å°è±†å³¶å…¨æ—¥", items: ["å¯’éœæºª", "é‡å²©", "é†¬æ²¹ç´€å¿µé¤¨", "ä¸¸é¾œåŸ"], hotelIdx: 8 },
            { date: "05/08", title: "é¦™å·ç§˜å¢ƒå·¡ç¦®", items: ["é‡‘åˆ€æ¯”ç¾…å®®", "é›²é‚Šå¯º", "çˆ¶æ¯æ¿±æµ·å²¸"], hotelIdx: 9 },
            { date: "05/09", title: "æ·¡è·¯å³¶ â” ç¥æˆ¶", items: ["æ·¡è·¯å¤¢èˆå°", "äºŒæ¬¡å…ƒä¹‹æ£®", "æ˜çŸ³æµ·å³½å…¬åœ’"], hotelIdx: 10 },
            { date: "05/10", title: "æ•£æœƒ", items: ["ç¥æˆ¶æœ€å¾Œå·¡ç¦®", "å‰å¾€æ©Ÿå ´/æ–°å¤§é˜ª", "å›å®¶"], hotelIdx: -1 }
        ],
        hotels: [
            {date:"4/29", name:"ERA ç¥æˆ¶ä¸‰å®®", price:23400, url:"https://travel.rakuten.co.jp/HOTEL/167683/167683.html", splitMembers: []},
            {date:"4/30", name:"æ±æ¨ªINN å¾·å³¶", price:22052, url:"https://travel.rakuten.co.jp/HOTEL/68537/68537.html", splitMembers: []},
            {date:"5/1", name:"ç¥–è°·è¦³å…‰æ—…é¤¨", price:40000, url:"https://travel.rakuten.co.jp/HOTEL/142344/142344.html", splitMembers: []},
            {date:"5/2", name:"æ˜Ÿç¾…å››ä¸‡å", price:116600, url:"https://travel.rakuten.co.jp/HOTEL/70733/70733.html", splitMembers: []},
            {date:"5/3", name:"æ„›çµ²éœ²æ¾å±±", price:36120, url:"https://travel.rakuten.co.jp/HOTEL/13883/13883.html", splitMembers: []},
            {date:"5/4", name:"æ±æ¨ªINN ç¦å±±", price:29700, url:"https://travel.rakuten.co.jp/HOTEL/151477/151477.html", splitMembers: []},
            {date:"5/5", name:"ãã‚ŒãŸã‘å²¡å±±", price:22680, url:"https://travel.rakuten.co.jp/HOTEL/158311/158311.html", splitMembers: []},
            {date:"5/6", name:"ã‚ªãƒªãƒ“ã‚¢ãƒ³å°è±†å³¶", price:68500, url:"https://www.jalan.net/yad307396/", splitMembers: []},
            {date:"5/7", name:"APA ä¸¸é¾œ", price:22400, url:"https://travel.rakuten.co.jp/HOTEL/80598/80598.html", splitMembers: []},
            {date:"5/8", name:"ã‚¢ãƒ†ãƒ¼ãƒŠæµ·æœˆ", price:18000, url:"https://travel.rakuten.co.jp/HOTEL/54177/54177.html", splitMembers: []},
            {date:"5/9", name:"æ±æ¨ªINN ç¥æˆ¶", price:31680, url:"https://travel.rakuten.co.jp/HOTEL/108407/108407.html", splitMembers: []}
        ],
        otherExpenses: [
            { title: "Toyota Rent-A-Car", amount: 137679, splitMembers: [] }
        ],
        fixedExpenses: [],
        members: [], expenses: []
    };

    let appData = JSON.parse(JSON.stringify(defaultData));

    // --- é›²ç«¯ ---
    async function initCloudSync() {
        const inputPwd = document.getElementById('secret-password').value;
        if(!inputPwd) { showLoginMsg("è«‹è¼¸å…¥å¯†ç¢¼"); return; }
        PASSWORD = inputPwd;
        document.getElementById('login-box').classList.add('hidden'); document.getElementById('loading-spinner').classList.remove('hidden');
        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { 'X-Master-Key': API_KEY } });
            const result = await response.json(); const encryptedStr = result.record.data; 
            if (!encryptedStr) { await saveToCloud(); closeOverlay(); renderAll(); return; }
            const bytes = CryptoJS.AES.decrypt(encryptedStr, PASSWORD);
            appData = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
            if (!appData.hotels) appData.hotels = defaultData.hotels;
            if (!appData.otherExpenses) appData.otherExpenses = defaultData.otherExpenses;
            if (!appData.fixedExpenses) appData.fixedExpenses = [];
            updateStatus("åŒæ­¥å®Œæˆ"); closeOverlay(); renderAll();
        } catch (e) { document.getElementById('loading-spinner').classList.add('hidden'); document.getElementById('login-box').classList.remove('hidden'); showLoginMsg("å¯†ç¢¼éŒ¯èª¤"); }
    }
    async function saveToCloud() {
        updateStatus("ä¸Šå‚³ä¸­...");
        try {
            const encryptedStr = CryptoJS.AES.encrypt(JSON.stringify(appData), PASSWORD).toString();
            await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY }, body: JSON.stringify({ data: encryptedStr }) });
            updateStatus("å·²å„²å­˜", true);
        } catch (error) { updateStatus("ä¸Šå‚³å¤±æ•—", false, true); }
    }
    function closeOverlay() { document.getElementById('loading-overlay').style.opacity = '0'; setTimeout(() => document.getElementById('loading-overlay').remove(), 500); }
    function showLoginMsg(msg) { document.getElementById('login-msg').innerText = msg; }
    function updateStatus(msg, success = true, error = false) { document.getElementById('cloud-status').innerHTML = (success ? '<i class="fas fa-check-circle text-green-400"></i>' : (error ? '<i class="fas fa-exclamation-triangle text-red-400"></i>' : '<i class="fas fa-sync fa-spin text-blue-400"></i>')) + ' ' + msg; }

    function renderAppTitle() { document.getElementById('app-main-title').innerText = appData.appTitle || "SHIKOKU 2026"; }
    function editAppTitle() { const t = prompt("ä¿®æ”¹ä¸»æ¨™é¡Œ:", appData.appTitle); if(t) { appData.appTitle = t; renderAppTitle(); saveToCloud(); } }

    // --- è¡Œç¨‹åŠŸèƒ½ ---
    function formatDateDisplay(yyyy_mm_dd) { 
        if(!yyyy_mm_dd) return ""; const parts = yyyy_mm_dd.split('-');
        if (parts.length === 3) return `${parts[1]}/${parts[2]}`; return yyyy_mm_dd;
    }
    function getYearForInput(displayDate) { if(displayDate.includes('-')) return displayDate; return `2026-${displayDate.replace('/', '-')}`; }
    function sortTripData() { appData.tripData.sort((a, b) => { const dateA = new Date(getYearForInput(a.date)); const dateB = new Date(getYearForInput(b.date)); return dateA - dateB; }); }

    function renderItinerary() {
        const list = document.getElementById('itinerary-list');
        list.innerHTML = appData.tripData.map((day, dIdx) => {
            const hotelInfo = (day.hotelIdx >= 0 && appData.hotels[day.hotelIdx]) ? appData.hotels[day.hotelIdx] : { name: "ç„¡ä½å®¿è³‡æ–™", url: "#" };
            const itemsHtml = day.items.map((item, iIdx) => {
                let navLink = "";
                if (iIdx > 0) {
                    const prevItem = day.items[iIdx-1];
                    const mapUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(prevItem)}&destination=${encodeURIComponent(item)}&travelmode=driving`;
                    navLink = `<div class="ml-8 pl-4 border-l-2 border-dashed border-indigo-200 py-2"><a href="${mapUrl}" target="_blank" class="inline-flex items-center text-[10px] text-indigo-500 bg-indigo-50 px-2 py-1 rounded-full"><i class="fas fa-route mr-1"></i>å°èˆª</a></div>`;
                }
                return `
                ${navLink}
                <div class="draggable-item bg-white p-3 rounded-lg shadow-sm border border-slate-100 flex justify-between items-center z-10 relative" draggable="true" data-didx="${dIdx}" data-iidx="${iIdx}">
                    <div class="flex items-center gap-3 flex-grow"><i class="fas fa-grip-vertical text-slate-300"></i><span onclick="editNode(${dIdx}, ${iIdx})" class="editable font-medium text-slate-600 flex-grow">${item}</span></div>
                    <div class="flex space-x-1"><button onclick="deleteNode(${dIdx}, ${iIdx})" class="p-2 text-red-300"><i class="fas fa-times"></i></button></div>
                </div>`
            }).join('');

            return `
            <div class="relative pb-2">
                <div class="flex items-center mb-1 sticky top-16 bg-slate-100 z-20 py-2">
                    <span onclick="openItineraryModal('editDate', ${dIdx})" class="date-badge bg-slate-800 text-white text-[10px] px-2 py-1 rounded font-bold mr-2 shadow-sm">${day.date}</span>
                    <h2 onclick="editTitle(${dIdx})" class="editable text-lg font-black text-slate-800 flex-grow px-1">${day.title}</h2>
                </div>
                <div class="space-y-1 pl-2 border-l-2 border-slate-200 ml-2 relative">
                    ${itemsHtml}
                    <div class="bg-orange-50 p-3 rounded-lg flex justify-between items-center text-xs font-bold text-orange-800 border border-orange-100 mt-2 z-10 relative"><span><i class="fas fa-bed mr-2"></i>${hotelInfo.name}</span>${hotelInfo.url!=='#'?`<a href="${hotelInfo.url}" target="_blank" class="bg-white px-3 py-1 rounded shadow-sm">è¨‚æˆ¿</a>`:''}</div>
                </div>
            </div>`
        }).join('');
        setupDragAndDrop();
    }

    let itiModalMode = 'add'; let itiModalTargetIdx = null;
    function openItineraryModal(mode, idx = null) {
        itiModalMode = mode; itiModalTargetIdx = idx;
        const modal = document.getElementById('itinerary-modal'); const title = document.getElementById('itinerary-modal-title'); const dateInput = document.getElementById('iti-date'); const nameGroup = document.getElementById('iti-name-group');
        dateInput.valueAsDate = new Date();
        if (mode === 'add') { title.innerText = "æ–°å¢è¡Œç¨‹ç¯€é»"; nameGroup.classList.remove('hidden'); document.getElementById('iti-name').value = ""; } 
        else if (mode === 'editDate') { title.innerText = "ä¿®æ”¹æ­¤æ—¥æ—¥æœŸ"; nameGroup.classList.add('hidden'); dateInput.value = getYearForInput(appData.tripData[idx].date); }
        modal.classList.remove('hidden');
    }

    function saveItineraryNode() {
        const dateRaw = document.getElementById('iti-date').value; if (!dateRaw) return alert("è«‹é¸æ“‡æ—¥æœŸ");
        const displayDate = formatDateDisplay(dateRaw);
        if (itiModalMode === 'add') {
            const name = document.getElementById('iti-name').value; if (!name) return alert("è«‹è¼¸å…¥æ™¯é»åç¨±");
            let dayObj = appData.tripData.find(d => d.date === displayDate);
            if (dayObj) { dayObj.items.push(name); } 
            else { appData.tripData.push({ date: displayDate, title: "æ–°çš„ä¸€å¤©", items: [name], hotelIdx: -1 }); sortTripData(); }
        } else if (itiModalMode === 'editDate') {
            if (itiModalTargetIdx !== null) { appData.tripData[itiModalTargetIdx].date = displayDate; sortTripData(); }
        }
        document.getElementById('itinerary-modal').classList.add('hidden'); renderItinerary(); saveToCloud();
    }

    function editTitle(i){ const v=prompt("ä¿®æ”¹æ¨™é¡Œ:", appData.tripData[i].title); if(v){ appData.tripData[i].title=v; renderItinerary(); saveToCloud(); }}
    function editNode(d,i){ const v=prompt("ä¿®æ”¹æ™¯é»:", appData.tripData[d].items[i]); if(v){ appData.tripData[d].items[i]=v; renderItinerary(); saveToCloud(); }}
    function deleteNode(d,i){ 
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹é»ï¼Ÿ")){ 
            appData.tripData[d].items.splice(i,1); 
            if (appData.tripData[d].items.length === 0) appData.tripData.splice(d, 1);
            renderItinerary(); saveToCloud(); 
        }
    }
    
    function addNodePrompt(){ const d=prompt("æ—¥æœŸ (ä¾‹ 05/01):"); const i=prompt("æ™¯é»:"); const day=appData.tripData.find(x=>x.date===d); if(day&&i){ day.items.push(i); renderItinerary(); saveToCloud(); } else { alert("æ‰¾ä¸åˆ°æ—¥æœŸ"); } }
    
    let dragSrcEl=null, dragSrcDIdx=null, dragSrcIIdx=null;
    function setupDragAndDrop() {
        document.querySelectorAll('.draggable-item').forEach(item => {
            item.addEventListener('dragstart', function(e) { this.classList.add('dragging'); dragSrcEl=this; dragSrcDIdx=parseInt(this.dataset.didx); dragSrcIIdx=parseInt(this.dataset.iidx); });
            item.addEventListener('dragover', e => e.preventDefault());
            item.addEventListener('dragend', function() { this.classList.remove('dragging'); });
            item.addEventListener('drop', function(e) {
                e.stopPropagation(); const target = e.target.closest('.draggable-item');
                if (dragSrcEl !== target && target) {
                    const tDIdx=parseInt(target.dataset.didx); const tIIdx=parseInt(target.dataset.iidx);
                    if (dragSrcDIdx === tDIdx) { const items = appData.tripData[dragSrcDIdx].items; const [moved] = items.splice(dragSrcIIdx, 1); items.splice(tIIdx, 0, moved); renderItinerary(); saveToCloud(); } 
                    else alert("åƒ…æ”¯æ´åŒæ—¥æ’åº");
                }
            });
        });
    }

    // --- é ç®—èˆ‡äººå“¡ç®¡ç† ---
    function addMemberFromFinance() { const name = document.getElementById('finance-new-member').value.trim(); if(name && !appData.members.includes(name)) { appData.members.push(name); document.getElementById('finance-new-member').value=''; renderMembers(); saveToCloud(); } }
    function removeMember(name) { if(confirm(`åˆªé™¤äººå“¡ ${name}ï¼Ÿ`)) { appData.members = appData.members.filter(m => m !== name); renderMembers(); saveToCloud(); } }
    function renderMembers() {
        const html = appData.members.map(m => `<span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full text-[10px] font-bold flex items-center">${m} <i class="fas fa-times ml-1 cursor-pointer hover:text-red-500" onclick="removeMember('${m}')"></i></span>`).join('');
        document.getElementById('member-tags-finance').innerHTML = html;
        document.getElementById('member-tags-ledger').innerHTML = appData.members.map(m => `<span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full text-[10px] font-bold">${m}</span>`).join('');
        document.getElementById('member-count-finance').innerText = `${appData.members.length}äºº`;
    }
    let currentEditType = null; let currentEditIdx = null;
    function openMemberSelectModal(type, idx) {
        if(appData.members.length === 0) return alert("è«‹å…ˆæ–°å¢äººå“¡åå–®ï¼");
        currentEditType = type; currentEditIdx = idx;
        let currentSelected = (type === 'hotel') ? (appData.hotels[idx].splitMembers || []) : (appData.otherExpenses[idx].splitMembers || []);
        document.getElementById('member-checkbox-list').innerHTML = appData.members.map(m => `<label class="flex items-center space-x-2 bg-slate-50 p-2 rounded cursor-pointer border border-slate-200"><input type="checkbox" value="${m}" ${currentSelected.includes(m) ? 'checked' : ''} class="member-select-cb accent-indigo-600"><span class="text-xs font-bold text-slate-700">${m}</span></label>`).join('');
        document.getElementById('save-members-btn').onclick = saveSelectedMembers;
        document.getElementById('member-select-modal').classList.remove('hidden');
    }
    function saveSelectedMembers() {
        const selected = Array.from(document.querySelectorAll('.member-select-cb:checked')).map(cb => cb.value);
        if(currentEditType === 'hotel') appData.hotels[currentEditIdx].splitMembers = selected; else appData.otherExpenses[currentEditIdx].splitMembers = selected;
        document.getElementById('member-select-modal').classList.add('hidden'); renderFinancePage(); saveToCloud();
    }
    function renderHotelTable(){
        let total = 0;
        document.getElementById('hotel-list-body').innerHTML=appData.hotels.map((h, idx) => {
            total += h.price;
            const splitCount = (h.splitMembers && h.splitMembers.length > 0) ? h.splitMembers.length : 0;
            const perPerson = splitCount > 0 ? Math.round(h.price / splitCount) : 0;
            let splitDisplay = splitCount > 0 ? `<span class="text-[10px] bg-indigo-50 text-indigo-600 px-1 rounded">${splitCount}äººåˆ†</span>` : `<span class="text-[10px] text-red-400">æœªè¨­å®š</span>`;
            return `<tr class="border-b border-orange-100 group"><td class="p-2"><div class="font-bold text-slate-600 editable" onclick="editHotel(${idx}, 'date')">${h.date}</div><a href="${h.url}" target="_blank" class="text-indigo-600 text-[10px] block truncate max-w-[100px]" onclick="event.stopPropagation();">${h.name}</a></td><td class="p-2 text-center editable" onclick="openMemberSelectModal('hotel', ${idx})">${splitDisplay}<div class="text-[8px] text-slate-400 truncate max-w-[60px]">${h.splitMembers ? h.splitMembers.join(',') : ''}</div></td><td class="p-2 text-right font-mono text-slate-500 text-[10px]">Â¥${perPerson.toLocaleString()}</td><td class="p-2 text-right font-mono font-bold text-orange-600 editable" onclick="editHotel(${idx}, 'price')">Â¥${h.price.toLocaleString()}</td><td class="p-2 text-right"><button onclick="deleteHotel(${idx})" class="text-slate-300 hover:text-red-500 text-xs"><i class="fas fa-trash"></i></button></td></tr>`;
        }).join('');
        document.getElementById('hotel-total').innerText = 'Â¥' + total.toLocaleString();
    }
    
    // ä½å®¿ Modal
    function openHotelModal() {
        document.getElementById('hotel-input-date').valueAsDate = new Date();
        document.getElementById('hotel-input-name').value = '';
        document.getElementById('hotel-input-price').value = '';
        document.getElementById('hotel-input-url').value = '';
        document.getElementById('hotel-modal').classList.remove('hidden');
    }
    function saveHotel() {
        const dRaw = document.getElementById('hotel-input-date').value; const name = document.getElementById('hotel-input-name').value; const price = parseInt(document.getElementById('hotel-input-price').value); const url = document.getElementById('hotel-input-url').value || '#';
        if(!dRaw || !name || isNaN(price)) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
        const displayDate = formatDateDisplay(dRaw);
        appData.hotels.push({ date: displayDate, name: name, price: price, url: url, splitMembers: [] });
        appData.hotels.sort((a, b) => { const da = new Date(getYearForInput(a.date)); const db = new Date(getYearForInput(b.date)); return da - db; });
        renderFinancePage(); saveToCloud(); document.getElementById('hotel-modal').classList.add('hidden');
    }

    function deleteHotel(idx) { if(confirm("åˆªé™¤?")) { appData.hotels.splice(idx, 1); renderFinancePage(); saveToCloud(); }}
    function editHotel(idx, field) { if(field === 'date') { const v = prompt("ä¿®æ”¹æ—¥æœŸ:", appData.hotels[idx].date); if(v) appData.hotels[idx].date = v; } if(field === 'price') { const v = parseInt(prompt("ä¿®æ”¹ç¸½é‡‘é¡:", appData.hotels[idx].price)); if(!isNaN(v)) appData.hotels[idx].price = v; } renderFinancePage(); saveToCloud(); }
    
    // å…¶é¤˜é ç®— (v21: æ•´åˆ Modal)
    let editingOtherBudgetIdx = null; 
    function openOtherBudgetModal(mode, idx = null) {
        const modal = document.getElementById('other-budget-modal');
        const titleEl = document.getElementById('other-budget-title');
        const nameInput = document.getElementById('ob-title');
        const amtInput = document.getElementById('ob-amount');
        const splitContainer = document.getElementById('ob-split-container');
        
        // æ¸²æŸ“åˆ†æ”¤å‹¾é¸æ¡†
        let currentSelected = [];
        if (mode === 'edit') currentSelected = appData.otherExpenses[idx].splitMembers || [];
        else if (mode === 'add') currentSelected = appData.members; // é è¨­å…¨é¸

        splitContainer.innerHTML = appData.members.map(m => `
            <label class="flex items-center space-x-2 bg-slate-50 p-2 rounded cursor-pointer border border-slate-200">
                <input type="checkbox" value="${m}" ${currentSelected.includes(m) ? 'checked' : ''} class="ob-split-cb accent-indigo-600">
                <span class="text-xs font-bold text-slate-700">${m}</span>
            </label>`).join('');

        if (mode === 'add') {
            editingOtherBudgetIdx = null;
            titleEl.innerText = "æ–°å¢é ç®—é …ç›®";
            nameInput.value = '';
            amtInput.value = '';
        } else if (mode === 'edit') {
            editingOtherBudgetIdx = idx;
            titleEl.innerText = "ä¿®æ”¹é ç®—é …ç›®";
            nameInput.value = appData.otherExpenses[idx].title;
            amtInput.value = appData.otherExpenses[idx].amount;
        }
        modal.classList.remove('hidden');
    }

    function toggleOtherBudgetSplit() {
        const checks = document.querySelectorAll('.ob-split-cb');
        const allChecked = Array.from(checks).every(x => x.checked);
        checks.forEach(x => x.checked = !allChecked);
    }

    function saveOtherBudget() {
        const t = document.getElementById('ob-title').value;
        const a = parseInt(document.getElementById('ob-amount').value);
        if(!t || isNaN(a)) return alert("è«‹å¡«å¯«å®Œæ•´");
        
        const selectedMembers = Array.from(document.querySelectorAll('.ob-split-cb:checked')).map(cb => cb.value);

        if (editingOtherBudgetIdx !== null) {
            appData.otherExpenses[editingOtherBudgetIdx].title = t;
            appData.otherExpenses[editingOtherBudgetIdx].amount = a;
            appData.otherExpenses[editingOtherBudgetIdx].splitMembers = selectedMembers;
        } else {
            appData.otherExpenses.push({title:t, amount:a, splitMembers: selectedMembers});
        }
        
        document.getElementById('other-budget-modal').classList.add('hidden');
        renderFinancePage();
        saveToCloud();
    }

    function renderOtherExpenseTable() {
        let total = 0;
        document.getElementById('other-expense-body').innerHTML = appData.otherExpenses.map((item, idx) => {
            total += item.amount;
            const splitCount = (item.splitMembers && item.splitMembers.length > 0) ? item.splitMembers.length : 0;
            const perPerson = splitCount > 0 ? Math.round(item.amount / splitCount) : 0;
            let splitDisplay = splitCount > 0 ? `<span class="text-[10px] bg-slate-100 text-slate-600 px-1 rounded">${splitCount}äººåˆ†</span>` : `<span class="text-[10px] text-red-400">æœªè¨­å®š</span>`;
            
            // v21: é»æ“Šæ•´åˆ—é–‹å•Ÿç·¨è¼¯
            return `
            <tr class="border-b border-slate-100 group cursor-pointer hover:bg-slate-50" onclick="openOtherBudgetModal('edit', ${idx})">
                <td class="p-2"><div class="font-bold text-slate-700 text-xs">${item.title}</div></td>
                <td class="p-2 text-center">
                    ${splitDisplay}
                    <div class="text-[8px] text-slate-400 truncate max-w-[60px]">${item.splitMembers ? item.splitMembers.join(',') : ''}</div>
                </td>
                <td class="p-2 text-right font-mono text-slate-500 text-[10px]">Â¥${perPerson.toLocaleString()}</td>
                <td class="p-2 text-right font-mono font-bold text-slate-700">Â¥${item.amount.toLocaleString()}</td>
                <td class="p-2 text-right">
                    <button onclick="event.stopPropagation(); deleteOther(${idx})" class="text-slate-300 hover:text-red-500 text-xs"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        }).join('');
        document.getElementById('other-total').innerText = 'Â¥' + total.toLocaleString();
    }
    
    function deleteOther(idx) { if(confirm("åˆªé™¤?")) { appData.otherExpenses.splice(idx, 1); renderFinancePage(); saveToCloud(); }}
    
    function renderBudgetSummary() {
        if(appData.members.length === 0) return;
        let summary = {}; appData.members.forEach(m => summary[m] = 0);
        appData.hotels.forEach(h => { if(h.splitMembers && h.splitMembers.length > 0) { const perPerson = h.price / h.splitMembers.length; h.splitMembers.forEach(m => { if(summary[m] !== undefined) summary[m] += perPerson; }); }});
        appData.otherExpenses.forEach(o => { if(o.splitMembers && o.splitMembers.length > 0) { const perPerson = o.amount / o.splitMembers.length; o.splitMembers.forEach(m => { if(summary[m] !== undefined) summary[m] += perPerson; }); }});
        document.getElementById('budget-summary-list').innerHTML = Object.keys(summary).map(m => `<div class="flex justify-between items-center bg-indigo-50 p-2 rounded border border-indigo-100"><span class="font-bold text-sm text-indigo-900">${m}</span><span class="font-mono font-black text-indigo-600">Â¥${Math.round(summary[m]).toLocaleString()}</span></div>`).join('');
    }
    function renderFinancePage() { renderMembers(); renderHotelTable(); renderOtherExpenseTable(); renderBudgetSummary(); }
    function addFixedExpense() { const t = prompt("é …ç›®åç¨±:"); if(!t) return; const a = parseInt(prompt("é‡‘é¡:")); if(isNaN(a)) return; appData.fixedExpenses.push({title:t, amount:a}); renderFixedBudget(); saveToCloud(); }
    
    // è¨˜å¸³é‚è¼¯
    let editingExpenseIdx = null; 

    function renderLedgerUI(){ calculateSettlement(); }
    function renderLedgerTable(){
        const con=document.getElementById('expense-container'); if(appData.expenses.length===0){con.innerHTML=`<div class="text-center text-slate-300 py-10">å°šç„¡ç´€éŒ„</div>`;return;}
        const grp=appData.expenses.reduce((g,i,idx)=>{if(!g[i.date])g[i.date]=[];g[i.date].push({...i,oid:idx});return g;},{}); // oid æ˜¯åœ¨åŸé™£åˆ—çš„ç´¢å¼•
        con.innerHTML=Object.keys(grp).sort().map(d=>{
            let tot=0;
            const items=grp[d].map(i=>{ tot+=i.amount; return `<div onclick="openExpenseModal('edit', ${i.oid})" class="ledger-row flex justify-between items-center p-3 border-b border-slate-100 bg-white last:border-0"><div><div class="font-bold text-sm text-slate-700">${i.desc}</div><div class="text-[10px] text-slate-400">${i.payer} å¢Šä»˜ <span class="text-indigo-400">(${i.splitWith.join(', ')})</span></div></div><div class="text-right"><div class="font-mono font-bold text-indigo-600">Â¥${i.amount.toLocaleString()}</div><div class="text-[10px] text-slate-300"><i class="fas fa-pen"></i></div></div></div>`;}).join('');
            return `<div class="mb-4 rounded-xl overflow-hidden border border-slate-200 shadow-sm"><div class="bg-slate-50 p-2 flex justify-between items-center text-xs font-bold text-slate-600"><span>${d}</span><span>å°è¨ˆ Â¥${tot.toLocaleString()}</span></div>${items}</div>`;
        }).join('');
    }
    
    function openExpenseModal(mode, idx = null){
        if(appData.members.length<2)return alert("è«‹å…ˆåœ¨ã€é ç®—ã€‘é é¢æ–°å¢äººå“¡");
        const modal = document.getElementById('expense-modal');
        const delBtn = document.getElementById('expense-delete-btn');
        
        document.getElementById('input-payer').innerHTML=appData.members.map(m=>`<option value="${m}">${m}</option>`).join('');
        document.getElementById('input-split-container').innerHTML=appData.members.map(m=>`<label class="flex items-center bg-slate-50 p-2 rounded border cursor-pointer"><input type="checkbox" value="${m}" checked class="accent-indigo-600 split-check mr-2"><span class="text-xs">${m}</span></label>`).join('');

        if (mode === 'add') {
            editingExpenseIdx = null;
            document.getElementById('expense-modal-title').innerText = "æ–°å¢æ¶ˆè²»";
            delBtn.classList.add('hidden');
            document.getElementById('input-date').valueAsDate=new Date(); 
            document.getElementById('input-desc').value='';
            document.getElementById('input-amount').value='';
        } else if (mode === 'edit') {
            editingExpenseIdx = idx;
            document.getElementById('expense-modal-title').innerText = "ç·¨è¼¯æ¶ˆè²»";
            delBtn.classList.remove('hidden');
            const exp = appData.expenses[idx];
            document.getElementById('input-date').value = getYearForInput(exp.date);
            document.getElementById('input-desc').value = exp.desc;
            document.getElementById('input-amount').value = exp.amount;
            document.getElementById('input-payer').value = exp.payer;
            const checkboxes = document.querySelectorAll('.split-check');
            checkboxes.forEach(cb => { cb.checked = exp.splitWith.includes(cb.value); });
        }
        modal.classList.remove('hidden');
    }

    function saveExpense(){
        const dr=document.getElementById('input-date').value; const desc=document.getElementById('input-desc').value; const amt=parseInt(document.getElementById('input-amount').value); const payer=document.getElementById('input-payer').value;
        const sw=Array.from(document.querySelectorAll('.split-check:checked')).map(c=>c.value);
        if(!dr||isNaN(amt)||amt<=0||sw.length===0)return alert("è«‹å¡«å¯«å®Œæ•´");
        
        const d=new Date(dr); const ds=`${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
        const newExpense = {date:ds,desc,amount:amt,payer,splitWith:sw};

        if (editingExpenseIdx !== null) { appData.expenses[editingExpenseIdx] = newExpense; } 
        else { appData.expenses.push(newExpense); }
        
        document.getElementById('expense-modal').classList.add('hidden'); renderLedgerTable();calculateSettlement();saveToCloud();
    }
    
    function deleteExpenseFromModal() {
        if(editingExpenseIdx !== null && confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†æ¶ˆè²»ï¼Ÿ")) {
            appData.expenses.splice(editingExpenseIdx, 1);
            document.getElementById('expense-modal').classList.add('hidden');
            renderLedgerTable(); calculateSettlement(); saveToCloud();
        }
    }

    function delExp(i){if(confirm("åˆªé™¤?")){appData.expenses.splice(i,1);renderLedgerTable();calculateSettlement();saveToCloud();}}
    
    function calculateSettlement(){
        if(appData.members.length===0)return;
        let bal={};appData.members.forEach(m=>bal[m]=0);
        appData.expenses.forEach(e=>{const s=e.amount/e.splitWith.length;bal[e.payer]+=e.amount;e.splitWith.forEach(p=>{if(bal.hasOwnProperty(p))bal[p]-=s;});});
        let db=[],cr=[]; for(const[n,v]of Object.entries(bal)){const r=Math.round(v); if(r<-1)db.push({n,v:r});if(r>1)cr.push({n,v:r});}
        db.sort((a,b)=>a.v-b.v);cr.sort((a,b)=>b.v-a.v);
        let h='',d=0,c=0;
        while(d<db.length&&c<cr.length){
            let a=Math.min(Math.abs(db[d].v),cr[c].v);
            if(a>0)h+=`<div class="flex justify-between items-center bg-white p-2 rounded border border-slate-200 mb-1"><div class="flex items-center space-x-2"><span class="font-bold text-slate-700 bg-slate-100 px-2 rounded">${db[d].n}</span><i class="fas fa-arrow-right text-slate-300 text-[10px]"></i><span class="font-bold text-indigo-700 bg-indigo-50 px-2 rounded">${cr[c].n}</span></div><span class="font-black text-indigo-600">Â¥${a.toLocaleString()}</span></div>`;
            db[d].v+=a;cr[c].v-=a; if(Math.abs(db[d].v)<1)d++;if(cr[c].v<1)c++;
        }
        document.getElementById('settlement-result').innerHTML=h||'<div class="text-center text-slate-400">å¸³ç›®å·²çµæ¸…</div>';
    }
    function toggleAllSplit(){const c=document.querySelectorAll('.split-check');const a=Array.from(c).every(x=>x.checked);c.forEach(x=>x.checked=!a);}
    function switchTab(t){document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));document.getElementById(`${t}-page`).classList.add('active');['itinerary','finance','ledger'].forEach(x=>{document.getElementById(`tab-${x}`).className=x===t?"flex-1 py-2 text-sm font-bold rounded bg-white text-slate-900 shadow-sm transition-all":"flex-1 py-2 text-sm font-bold rounded text-slate-400 hover:bg-slate-700 hover:text-white transition-all";});}
    function renderAll(){renderAppTitle();renderItinerary();renderFinancePage();renderLedgerUI();renderLedgerTable();}

</script>
</body>
</html>